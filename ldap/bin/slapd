#!/bin/sh


# Specify path variable
PATH=/sbin:/usr/sbin:/bin:/usr/bin

# Kill me on all errors
set -e

# Stop processing if slapd is not there
[ -x /usr/sbin/slapd ] || exit 0

# INIST
if [[ -f /inist/env/inist.env.ksh ]]
then
  # la machine est correctement install√©e, tout va bien
  . /inist/env/inist.env.ksh
else
  # dans le cas ou la machine ne contient pas les fichiers d'environement inist
  # on defini en dur ceux dont on aura besoin
  RC_OK_TERMINE=0;       # RC_LIB[0]="Sortie normale."
  RC_ERR_PARAM=103;      # RC_LIB[103]="Erreur dans les parametres d'appel."
  RC_ERR_YETSTARTED=240; # RC_LIB[240]="L'application tourne deja."
  RC_ERR_NOTSTARTED=241; # RC_LIB[241]="L'application ne tourne pas."
  RC_ERR_NOPROCESS=242;  # RC_LIB[242]="Le processus ne tourne pas."
  RC_ERR_PROGRAM=255;    # RC_LIB[255]="Autre erreur."
fi

# Default location of the slapd.conf file
SLAPD_CONF=<?php echo getenv('APPNAME_HOME'); ?>/etc/slapd.conf

# System account to run the slapd server under. If empty the server
# will run as root.
SLAPD_USER="<?php echo getenv('APPNAME_USER'); ?>"

# System group to run the slapd server under. If empty the server will
# run in the primary group of its user.
SLAPD_GROUP="<?php echo getenv('APPNAME_GROUP'); ?>"

# Path to the pid file of the slapd server. If not set the init.d script
# will try to figure it out from $SLAPD_CONF (/etc/ldap/slapd.conf)
SLAPD_PIDFILE=

# Configure if the slurpd daemon should be started. Possible values:
# - yes:   Always start slurpd
# - no:    Never start slurpd
# - auto:  Start slurpd if a replica option is found in slapd.conf (default)
SLURPD_START=auto

# slapd normally serves ldap only on all TCP-ports 389. slapd can also
# service requests on TCP-port 636 (ldaps) and requests via unix
# sockets.
# Example usage:
# SLAPD_SERVICES="ldap://127.0.0.1:389/ ldaps:/// ldapi:///"
SLAPD_SERVICES="ldap://<?php echo getenv('APPNAME_LDAP_LISTEN_INTERFACE'); ?>:<?php echo getenv('APPNAME_LDAP_PORT'); ?>/"

# Additional options to pass to slapd and slurpd
SLAPD_OPTIONS=""
SLURPD_OPTIONS=""

# Pour la gestion des log
SLAPD_LOG="<?php echo getenv('APPNAME_HOME'); ?>/logs/ldap.log"
SLAPD_LOGLEVEL="-d 256"
#SLAPD_LOGLEVEL="-d 16383"

# Load the default location of the slapd config file
if [ -z "$SLAPD_CONF" ]; then
	SLAPD_CONF="/etc/ldap/slapd.conf"
else
	SLAPD_OPTIONS="-f $SLAPD_CONF $SLAPD_OPTIONS"
	SLURPD_OPTIONS="-f $SLAPD_CONF $SLURPD_OPTIONS"
fi

# Stop processing if the config file is not there
if [ ! -r "$SLAPD_CONF" ]; then
  cat <<EOF >&2
No configuration file was found for slapd at $SLAPD_CONF.
If you have moved the slapd configuration file please modify
/etc/default/slapd to reflect this.  If you chose to not
configure slapd during installation then you need to do so
prior to attempting to start slapd.
An example slapd.conf is in /usr/share/slapd
EOF
  exit 0 # Should this be 1?
fi

# Figure out some default settings
# Check wether slurpd should get started
if [ "$SLURPD_START" != "yes" ] && [ "$SLURPD_START" != "no" ]; then
	if grep -q '^replica' "$SLAPD_CONF" > /dev/null 2>&1 ; then
		SLURPD_START=yes
	else
		SLURPD_START=no
	fi
fi
	
# Find out the name of slapd's pid file
if [ -z "$SLAPD_PIDFILE" ]; then
	SLAPD_PIDFILE=`sed -ne 's/^pidfile[[:space:]]\+\(.\+\)/\1/p' \
		"$SLAPD_CONF"`
fi

# XXX: Breaks upgrading if there is no pidfile (invoke-rc.d stop will fail)
# -- Torsten
if [ -z "$SLAPD_PIDFILE" ]; then
	cat <<EOF >&2
The pidfile for slapd is neither specified in "$SLAPD_CONF" nor
in /etc/default/slapd. Consequently, slapd will not be started.
EOF
	exit 1
fi

# Make sure the pidfile directory exists with correct permissions
piddir=`dirname "$SLAPD_PIDFILE"`
if [ ! -d "$piddir" ]; then
	mkdir -p "$piddir"
	[ -z "$SLAPD_USER" ] || chown -R "$SLAPD_USER" "$piddir"
	[ -z "$SLAPD_GROUP" ] || chgrp -R "$SLAPD_GROUP" "$piddir"
fi

# Pass the user and group to run under to slapd
if [ "$SLAPD_USER" ]; then
	SLAPD_OPTIONS="-u $SLAPD_USER $SLAPD_OPTIONS"
fi

if [ "$SLAPD_GROUP" ]; then
	SLAPD_OPTIONS="-g $SLAPD_GROUP $SLAPD_OPTIONS"
fi

# Tell the user that something went wrong and give some hints for
# resolving the problem.
report_failure() {
	if [ -n "$reason" ]; then
		echo " - failed: "
		echo "$reason"
	else
		echo " - failed."
		cat <<EOF
The operation failed but no output was produced. For hints on what went
wrong please refer to the system's logfiles (e.g. /var/log/syslog) or
try running the daemon in Debug mode like via "slapd -d 16383" (warning:
this will create copious output).
EOF

		if [ -n "$SLURPD_OPTIONS" -o \
		     -n "$SLAPD_OPTIONS" -o \
		     -n "$SLAPD_SERVICES" ]; then
			cat << EOF

Below, you can find the command line options used by this script to 
run slapd and slurpd. Do not forget to specify those options if you
want to look to debugging output:
EOF
	                if [ -z "$SLAPD_SERVICES" ]; then
				if [ -n "$SLAPD_OPTIONS" ]; then
					echo "  slapd $SLAPD_OPTIONS"
				fi
                	else
                        	echo "  slapd -h '$SLAPD_SERVICES' $SLAPD_OPTIONS"
                	fi

                	if [ "$SLURPD" = "yes" -a -n "$SLURPD_OPTIONS" ]; then
                       		echo "  slurpd $SLURPD_OPTIONS"
                	fi
		fi
	fi
}

# Start the slapd daemon and capture the error message if any to 
# $reason.
start_slapd() {
	echo -n " slapd"
	if [ -z "$SLAPD_SERVICES" ]; then
			/usr/sbin/slapd $SLAPD_OPTIONS $SLAPD_LOGLEVEL >> $SLAPD_LOG 2>&1 &
	else
			/usr/sbin/slapd -h "$SLAPD_SERVICES" $SLAPD_OPTIONS $SLAPD_LOGLEVEL >> $SLAPD_LOG 2>&1 &
	fi
}

# Start the slurpd daemon and capture the error message if any to
# $reason.
start_slurpd() {
	if [ "$SLURPD_START" != yes ]; then
		return 0
	fi
	echo -n " slurpd"
	reason="`start-stop-daemon --start --quiet --oknodo \
		--exec /usr/sbin/slurpd -- $SLURPD_OPTIONS 2>&1`"
}

# Stop the slapd daemon and capture the error message (if any) to
# $reason.
stop_slapd() {
	echo -n " slapd"
	reason="`start-stop-daemon --stop --quiet --oknodo --retry 10 \
		--pidfile "$SLAPD_PIDFILE" \
		--exec /usr/sbin/slapd 2>&1`"
}

# Stop the slurpd daemon and capture the error message (if any) to
# $reason.
stop_slurpd() {
	if [ "$SLURPD_START" != yes ]; then
		return 0
	fi
	echo -n " slurpd"
	reason="`start-stop-daemon --stop --quiet --oknodo --retry 10 \
		--exec /usr/sbin/slurpd 2>&1`"
}

# Start the OpenLDAP daemons
start() {
	echo -n "Starting OpenLDAP:"
	trap 'report_failure' 0
	start_slapd
	start_slurpd
	trap "-" 0
	echo .
}

# Stop the OpenLDAP daemons
stop() {
	echo -n "Stopping OpenLDAP:"
	trap 'report_failure' 0
	stop_slurpd
	stop_slapd
	trap "-" 0
	echo .
}

# Check if ldap is running
status() {
	if [[ ! -f ${SLAPD_PIDFILE} ]]
	then
                echo "OpenLDAP not started"
		exit ${RC_ERR_NOTSTARTED}
	fi
	pid=`cat ${SLAPD_PIDFILE}`
        ps -ef | cut -c 10-14,48- | grep "${pid}" | grep "<?php echo getenv('APPNAME_LDAP_PORT'); ?>" > /dev/null
	if [[ ${?} -ne 0 ]]
	then
                echo "OpenLDAP process not found"
		exit ${RC_ERR_NOPROCESS}
	fi  
        echo "OpenLDAP is listening on <?php echo getenv('APPNAME_LDAP_LISTEN_INTERFACE'); ?>:<?php echo getenv('APPNAME_LDAP_PORT'); ?> with pid ${pid}"
}

case "$1" in
  -r | start)
  	start ;;
  -s | stop)
  	stop ;;
  -c | check | status)
  	status ;;
  -u | restart | force-reload)
  	stop
	start
	;;
  *)
  	echo "Usage: $0 {start|stop|restart|force-reload|status}"
	exit 1
	;;
esac

exit ${RC_OK_TERMINE}